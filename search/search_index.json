{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"PowerController Application","text":"<p>The Power Controller is a Python-based automation tool that schedules and controls a power loads based on electricity pricing and a wide variety of user-configurable parameters and triggers. </p>"},{"location":"#features","title":"Features","text":"<ul> <li>Multiple output devices supported. </li> <li>Integrate with Amber Electric so that you can run a device (e.g. a pool pump) at the lowest possible rates.</li> <li>Supports switched outputs and meter only outputs.</li> <li>Integration with multiple Tesla vehicles to report on charging costs.</li> <li>Integrates with the majority of Shelly smart switches and energy meters to control and monitor you electrical devices.</li> <li>Dynamic Scheduling: Adjusts device operation based on real-time electricity prices.</li> <li>Normal scheduling: Turn devices on / off based on a time of day / day of week schedule, including support for dusk / dawn triggers. Schedule can be used for fall back if Amber pricing unavailable. Multiple schedules available.</li> <li>Override the output state using the webapp or an input line on a Shelly device.</li> <li>Support for complex output change sequences (e.g. turn on switch 1, wait for 20 seconds, turn on switch 2).</li> <li>Web app to view the current state of each device and manually override if needed. </li> <li>Integrate with a UPS and control and output based on the UPS's \"health\".</li> <li>Historical Tracking: Maintains past days of device runtime to optimize future scheduling.</li> <li>Integrates with the PowerControllerViewer app so that you can view and chart status and history of all your output devices and meters.</li> <li>Integrate with multiple temperature probes. Switch an output based on temperature thresholds. </li> <li>Set minimum, preferred and maximum operating times per day. Actual operating times are controlled by electicity prices and/or a predefined schedule. </li> <li>Vary preferred operating times each month (e.g. run your pool pump for longer in the summer).</li> <li>Email notification for critical errors and excess eneegy usage.</li> <li>Integration with the BetterStack uptime for heatbeat monitoring.</li> </ul>"},{"location":"#installation-and-configuration-guide","title":"Installation and Configuration Guide","text":"<p>The pages below will walk you through the process of installing and configuring the PowerController application.</p> <ul> <li>Instalation and Getting Started</li> <li>Configuration Guide</li> <li>Production Deployment</li> </ul>"},{"location":"features/","title":"Features","text":"<ul> <li>Multiple output devices supported. </li> <li>Integrate with Amber Electric so that you can run a device (e.g. a pool pump) at the lowest possible rates.</li> <li>Supports switched outputs and meter only outputs.</li> <li>Integration with multiple Tesla vehicles to report on charging costs.</li> <li>Integrates with the majority of Shelly smart switches and energy meters to control and monitor you electrical devices.</li> <li>Dynamic Scheduling: Adjusts device operation based on real-time electricity prices.</li> <li>Normal scheduling: Turn devices on / off based on a time of day / day of week schedule, including support for dusk / dawn triggers. Schedule can be used for fall back if Amber pricing unavailable. Multiple schedules available.</li> <li>Override the output state using the webapp or an input line on a Shelly device.</li> <li>Support for complex output change sequences (e.g. turn on switch 1, wait for 20 seconds, turn on switch 2).</li> <li>Web app to view the current state of each device and manually override if needed. </li> <li>Integrate with a UPS and control and output based on the UPS's \"health\".</li> <li>Historical Tracking: Maintains past days of device runtime to optimize future scheduling.</li> <li>Integrates with the PowerControllerViewer app so that you can view and chart status and history of all your output devices and meters.</li> <li>Integrate with multiple temperature probes. Switch an output based on temperature thresholds. </li> <li>Set minimum, preferred and maximum operating times per day. Actual operating times are controlled by electicity prices and/or a predefined schedule. </li> <li>Vary preferred operating times each month (e.g. run your pool pump for longer in the summer).</li> <li>Email notification for critical errors and excess eneegy usage.</li> <li>Integration with the BetterStack uptime for heatbeat monitoring.</li> </ul>"},{"location":"prod_deployment/","title":"Production Deployment","text":"<p>checklist </p>"},{"location":"running/","title":"Running and testing the PowerController app","text":"<p>By this stage you should have:</p> <p>\u2705 Installed the prerequisites \u2705 Installed and setup your Shelly device(s) \u2705 Installed the PowerController application \u2705 Configured the PowerController application</p> <p>Eventually, we'll get the app setup for a \"production\" environment, but initially we recommend running the application manually to check for configuration issues. Open a new terminal window and do the following:</p> <p>Talk about  - using launch script - rebiewing log files - Troubleshooting  - reference all the files generated (link to another page)</p> <p>T</p>"},{"location":"configuration/","title":"Configuration","text":"<p>The PowerController application is configured using the config.yaml file. An example Configuration File has been provided as part of the installation - you can copy this to config.yaml to get started. </p> <p>We recommend fully configuring the config file before attempting to run the application. When the app starts, it will do its best to validate the contents of the config file. That being said, some errors might not be reported until the app is fully running (see log files).</p> <p>You can edit config.yaml using nano:</p> <pre><code>nano config.yaml\n</code></pre> <p>...or you can copy it to a desktop system and use your favorite editor that include yaml syntax validation (we recommend VSCode with the redhat.vscode-yaml extension).</p> <p>The config file supports the following sections. Some of mandatory and some are optional. The same goes for the various keys in each section. The supported sections are outline below. A seperate help page has been provided for each one (click on the section name).</p> Section Description Required General General settings for the Power Controller application Yes Files Location of log and system state files Yes Email If you want to be emailed when there's a critical error or excessive energy use No Website Settings for the built-in web server that provides a web interface to view and control the outputs No AmberAPI Integration with the Amber Electric API to download real time energy prices for your home No ShellyDevices Describe the Shelly devices you want to control Yes Outputs Configure the behaviour of each outputs and/or meters that will control and monitor your electrical devices Yes OperatingSchedules Schedule used for switched outputs Yes OutputSequences Define a sequence of actions to perform on outputs when turning On or off No ViewerWebsite Integration with the PowerControllerViewer app No OutputMetering Logging of output energy consumption data to CSV and the system state file, as well as viewing and charting in the PowerControllerView application (if enabled) No TempProbeLogging Logging of temperature probes to CSV and the system state file, as well as viewing and charting in the PowerControllerView application (if enabled) No UPSIntegration Define one or more UPS units that can modify the behaviour of an Output No Location Specific the location of your home. Used to define dawn and dusk times in an operating schedule No TeslaMate Configure integration with the TeslaMate database to import Tesla charging session data No HeartbeatMonitor Integration with a Better Uptime heartbeat monitor to monitor uptime of the application No"},{"location":"configuration/example_config/","title":"Example Configuration File","text":"<p>This file (config_example.yaml) is available in the project root folder. You can use this as your starting point for the actual application configuration (config.yaml)</p> <pre><code># General settings for the Power Controller application\nGeneral:\n  Label: MyPower          # A label for this installation - used in the email subject and web viewer app\n  PollingInterval: 30     # Number of seconds to sleep between each check of the run plan and possible changes to outputs. Recommended 30 seconds.\n  # Some critical errors can trigger email notifications - for example the AmberAPI not responding. This is the time in minutes for an issue to \n  # persist before we send an email notification. Leave blank to disable.\n  ReportCriticalErrorsDelay: 30\n  DefaultPrice: 32.0      # A default price to use if the Amber API is not available and there is no schedule price defined  \n  ConsumptionDataFile: output_consumption_data.csv    # Output consumption data file - leave blank to disable\n  ConsumptionDataMaxDays: 30    # Maximum number of days to keep in the consumption data file. Set to -1 to disable truncation.\n\n\n# Settings for various log and state files\nFiles:\n  SavedStateFile: system_state.json    # The name of the saved state file. This is used to store the state of the device between runs.\n  LogfileName: logfile.log             # The name of the log file\n  LogfileMaxLines: 10000               # The maximum number of lines to keep in the log file\n  LogfileVerbosity: detailed           # How much information do we write to the log file. One of: none; error; warning; summary; detailed; debug; all\n  ConsoleVerbosity: detailed           # How much information do we write to the console. One of: error; warning; summary; detailed; debug; all\n\n\n# Enter your settings here if you want to be emailed when there's a critical error. Note that the SMTP username and password have been set in the .env file for security, but you can also set them here if you prefer.\nEmail:\n  EnableEmail: True                         # Set to True to enable email notifications \n  SendEmailsTo: &lt;Your email address here&gt;   # The email address to send notifications to\n  SMTPServer: &lt;Your SMTP server here&gt;       # The SMTP server to use to send the email\n  SMTPPort: 587                             # The SMTP server port\n  SubjectPrefix: \"[My PowerController]: \"   # A prefix to add to the email subject line\n\n\n# Settings for the built-in web server that provides a web interface to view and control the power controller\nWebsite:\n  HostingIP: 0.0.0.0          # The IP address to host the web server on. Use 0.0.0.0 to listen on all interfaces\n  Port: 8080                  # The port to host the web server on\n  PageAutoRefresh: 30         # How often to refresh the web page (in seconds). Set to 0 to disable auto-refresh.\n  AccessKey: &lt;Your website API key here&gt;   # An access key to secure the web interface. Alternatively, set the WEBAPP_ACCESS_KEY environment variable. Leave blank to disable access control.\n\n\n# Settings for the Amber API integration\nAmberAPI:\n  Mode: Live    # Operating mode for the Amber API: Live (attempt to download prices), Offline (pretend Amber API is offline, use cached prices). Disabled (fall back to schedule)\n  APIURL: https://api.amber.com.au/v1   # The base URL for the Amber API\n  APIKey: &lt;Your API key here&gt;    # The API key for your account, get one at app.amber.com.au/developers. Alternatively, set the AMBER_API_KEY environment variable.\n  RefreshInterval: 15       # How often to refresh the pricing data from Amber (in minutes) \n\n\n# Use this section to configure your Shelly devices\nShellyDevices:\n  ResponseTimeout: 3            # How long to wait in seconds for a response from a Shelly device\n  RetryCount: 1                 # Number of times to retry a request to a Shelly device if it fails\n  RetryDelay: 2                 # Number of seconds to wait between retries\n  MaxConcurrentErrors: 4        # Send an email notification if we get this number of concurrent errors\n  Devices:                      # List of Shelly devices to control\n    - Name: Shelly Pool 1        # A name for this device\n      Model: Shelly2PMG3        # The model of Shelly device\n      Hostname: 192.168.1.20   # The IP address or hostname of the Shelly device\n      Inputs:                   # List of inputs on the Shelly device to monitor\n        - Name: \"Filter Pump Override\"\n        - Name: \"Solar Pump Override\"\n      Outputs:                  # List of outputs on the Shelly device to control your devices\n        - Name: \"Filter Pump Power\"\n        - Name: \"Solar Pump Power\"\n      Meters:                  # List of meters on the Shelly device to monitor energy usage\n        - Name: \"Filter Pump Energy\"\n        - Name: \"Solar Pump Energy\"\n    - Name: Shelly Pool 2\n      Model: Shelly2PMG3        \n      Hostname: 192.168.1.21   \n      Simulate: False           \n      Outputs:                  \n        - Name: \"Solar Valve Actuator\"\n        - Name: \"Shelly Pool 2 O2\"\n      TempProbes: \n        - Name: \"Temp Pool Water\"\n          RequiresOutput: \"Filter Pump Power\"  # Only read this probe when the specified output is ON\n        - Name: \"Temp Solar Return\"\n          RequiresOutput: \"Solar Pump Power\"  # Only read this probe when the specified output is ON\n        - Name: \"Temp Roof\"\n    - Name: Spello Hot Water\n      Model: Shelly2PMG3\n      Hostname: 192.168.86.39\n      ExpectOffline: True       # Expect that this device will sometimes be offline and so don't report warnings when it happens\n      Outputs:\n        - Name: \"Hot Water O1\"\n        - Name: \"Hot Water O2\"\n      Meters:\n        - Name: \"Hot Water M1\"\n        - Name: \"Hot Water M2\"\n    - Name: Panel EM1\n      Model: ShellyEMG3\n      Hostname: 192.168.86.44\n      ExpectOffline: True\n      Meters:\n        - Name: \"Panel EM1.1\"\n        - Name: \"Panel EM1.2\"   \n    - Name: Network Rack\n      Model: Shelly2PMG3\n      Hostname: 192.168.86.30\n      Outputs:\n        - Name: \"Network Rack O1\"\n        - Name: \"Network Rack O2\"\n\n\n# Configure each switched output that controls your devices and how they behave\nOutputs:  \n  - Name: Pool Pump                 # A name for this output - used in the web interface  \n    Type: shelly                    # The type of output - shelly (default), teslamate or meter\n    DeviceOutput: Filter Pump Power  # The Shelly device output that controls this device - must match a Name in the ShellyDevices: Devices: Outputs section\n    Mode: BestPrice                 # Operating mode: BestPrice (run for target hours at best price), Schedule (run according to schedule only)\n    Schedule: Pool Pump             # The operating schedule to use when in Schedule mode - must match a Name in the OperatingSchedules section\n    ConstraintSchedule: Pool Heating  # An optional constraint schedule that limits when the output can run, even in BestPrice mode\n    AmberChannel: general           # The Amber pricing channel to use for this device, typically general or controlledLoad\n    DaysOfHistory: 7                # How many days of history to keep for this device\n    MinHours: 2                     # Minimum number of hours to run each day\n    MaxHours: 10                    # Maximum number of hours to run each day\n    TargetHours: 7                  # Target number of hours to run each day. Set to -1 to run for all hours that fall within best price or the schedule\n    MonthlyTargetHours:             # Override the TargetHours for a specific month of the year \n      January: 8\n      February: 8\n      June: 6\n      July: 6\n      August: 6\n      December: 8     \n    MaxShortfallHours: 4            # Maximum number of shortfall hours we can carry forward from previous days. Ignored if TargetHours is -1. Set to 0 to disable.\n    MaxBestPrice: 23.0              # The maximum price to run at when in BestPrice mode. \n    MaxPriorityPrice: 35.0          # The maximum price to run when we haven't run for the minimum number of hours yet.\n    DeviceMeter: Filter Pump Energy  # The Shelly device meter to use to track energy usage - must match a Name in the ShellyDevices: Devices: Meters section\n    MaxDailyEnergyUse: 6000         # Maximum energy use expected in Wh per day. An email warning will be sent if this is exceeded.\n    DeviceInput: Filter Pump Override   # Optional: The Shelly device input to used override the state of the output - must match a Name in the ShellyDevices: Devices: Inputs section\n    DeviceInputMode: TurnOn         # If a DeviceInput is specified, this controls how is is used. Ignore: Ignore the state of the inputs. TurnOn: Turn output on if input is off. TurnOff: Turn output off if input is on.\n    MinOnTime: 30                   # Minimum minutes to stay on once turned on\n    MinOffTime: 10                  # Minimum minutes to stay off (prevent rapid cycling). Cannot be set if MaxffTime is set.\n  - Name: Solar Heating\n    Type: shelly\n    DeviceOutput: Solar Pump Power\n    Mode: Schedule\n    Schedule: Pool Heating\n    AmberChannel: general\n    TargetHours: -1\n    MaxBestPrice: 23.0\n    MaxPriorityPrice: 35.0\n    DeviceMeter: Solar Pump Energy\n    ParentOutput: Pool Pump               # Optional: The name of a parent output that must be ON for this output to run\n    TurnOnSequence: Turn On Solar Pump    # Optional: Name of the output sequence to run when turning on this output\n    TurnOffSequence: Turn Off Solar Pump  # Optional: Name of the output sequence to run when turning off this output\n    MaxAppOnTime: 60               # If we turned this output on via the app, revert to auto after this number of minutes. Set to 0 to disable.\n    MaxAppOffTime: 60              # If we turned this output off via the app, revert to auto after this number of minutes. Set to 0 to disable.\n    TempProbeConstraints:       # Optional list of temperature probe constraints that must be met for the output to run\n      - TempProbe: Temp Roof\n        Condition: GreaterThan\n        Temperature: 32.0\n      - TempProbe: Temp Pool Water\n        Condition: LessThan\n        Temperature: 30.0    \n  - Name: Hot Water Heater\n    Type: shelly\n    DeviceOutput: Hot Water O1\n    Mode: BestPrice\n    Schedule: Hot Water\n    AmberChannel: controlledLoad\n    TargetHours: -1\n    MaxBestPrice: 23.0\n    MaxPriorityPrice: 30.0\n    DeviceMeter: Hot Water M1\n    HideFromWebApp: True      # If True, this output will not be shown in the built-in web app\n    HideFromViewerApp: True  # If True, this output will not be shown in the PowerControllerViewer app\n  - Name: Tesla\n    Type: teslamate\n    CarID: 1                   # The ID of the car in TeslaMate to control (this is usually 1 if you only have one car)\n    DaysOfHistory: 14            # How many days of history to keep for this device in the system state file\n    AmberChannel: general       # The Amber pricing channel to use for pricing this device, typically general or controlledLoad\n    Schedule: General           # The operating schedule to use for pricing this device when not using Amber pricing - must match a Name in the OperatingSchedules section\n  - Name: \"EM1.1 Living &amp; Beds\"\n    Type: meter\n    DeviceMeter: Panel EM1.1\n    Mode: BestPrice\n    Schedule: General\n    PowerOnThresholdWatts: 40\n    PowerOffThresholdWatts: 10\n    MinEnergyToLog: 20\n    HideFromViewerApp: True\n  - Name: \"EM1.2 Kitchen &amp; Laundry\"\n    Type: meter\n    DeviceMeter: Panel EM1.2\n    Mode: BestPrice\n    Schedule: General\n    PowerOnThresholdWatts: 40\n    PowerOffThresholdWatts: 10\n    MinEnergyToLog: 20\n    HideFromViewerApp: True\n  - Name: Network Rack\n    DeviceOutput: Network Rack O1\n    Mode: BestPrice\n    Schedule: General\n    AmberChannel: general\n    TargetHours: -1\n    MaxShortfallHours: 0\n    MaxBestPrice: 60.0\n    MaxPriorityPrice: 60.0\n    UPSIntegration: \n      UPS: APC UPS\n      ActionIfUnhealthy: TurnOn\n\n\n# Define the operating schedules for your devices. These are used to determine when a device is allowed to run when not using the Amber pricing data.\nOperatingSchedules:\n  - Name: Pool Pump           # A name for this schedule - used in the Outputs section\n    Windows:                  # List of time windows when the schedule is active\n      - StartTime: \"00:00\"\n        EndTime: \"07:30\"\n        DaysOfWeek: All       # Days of the week this window applies to - Mon, Tue, Wed, Thu, Fri, Sat, Sun or All. Multiple days can be specified separated by commas\n        Price: 20\n      - StartTime: \"07:30\"\n        EndTime: \"09:00\"\n        DaysOfWeek: All\n        Price: 16\n      - StartTime: \"09:00\"\n        EndTime: \"15:00\"\n        DaysOfWeek: All\n        Price: 13\n      - StartTime: \"15:00\"\n        EndTime: \"17:00\"\n        DaysOfWeek: All\n        Price: 33\n      - StartTime: \"17:00\"\n        EndTime: \"21:00\"\n        DaysOfWeek: All\n        Price: 51\n      - StartTime: \"21:00\"\n        EndTime: \"23:59\"\n        DaysOfWeek: All\n        Price: 22\n  - Name: Pool Heating\n    Windows: \n      - StartTime: \"10:00\"\n        EndTime: \"16:00\"\n        DaysOfWeek: All\n      - StartTime: \"22:00\"\n        EndTime: \"23:59\"\n        DaysOfWeek: All\n  - Name: Hot Water\n    Windows: \n      - StartTime: \"00:00\"\n        EndTime: \"14:00\"\n        DaysOfWeek: All\n        Price: 18\n      - StartTime: \"22:00\"\n        EndTime: \"23:59\"\n        DaysOfWeek: All\n        Price: 20\n\n\n# Use this to define a sequence of actions to perform on outputs when turning On or off\nOutputSequences:\n  - Name: \"Turn On Solar Pump\"\n    Description: \"Turn on the actuator valve, wait for 1 minute then turn on the solar booster pump\"\n    Timeout: 90\n    Steps:\n      - Type: CHANGE_OUTPUT\n        OutputIdentity: \"Solar Valve Actuator\"\n        State: True\n        Retries: 2\n        RetryBackoff: 1.0\n      - Type: SLEEP\n        Seconds: 60.0\n      - Type: CHANGE_OUTPUT\n        OutputIdentity: \"Solar Pump Power\"\n        State: True\n        Retries: 2\n        RetryBackoff: 1.0\n  - Name: \"Turn Off Solar Pump\"\n    Description: \"Turn off the solar booster pump, wait for 10 seconds then turn off the actuator valve\"\n    Timeout: 30\n    Steps:\n      - Type: CHANGE_OUTPUT\n        OutputIdentity: \"Solar Pump Power\"\n        State: False\n        Retries: 2\n        RetryBackoff: 1.0\n      - Type: SLEEP\n        Seconds: 10.0\n      - Type: CHANGE_OUTPUT\n        OutputIdentity: \"Solar Valve Actuator\"\n        State: False\n        Retries: 2\n        RetryBackoff: 1.0\n\n\n# Use this section to configure integration with the PowerControllerViewer app - see https://github.com/NickElseySpelloC/PowerControllerViewer\nViewerWebsite:\n  Enable: False                   # Set to True to enable integration with the PowerControllerViewer app\n  BaseURL: http://localhost:8000  # The base URL of the PowerControllerViewer app\n  AccessKey: &lt;Your website API key here&gt;  # The access key for the PowerControllerViewer app. Alternatively, set the VIEWER_ACCESS_KEY environment variable.\n  APITimeout: 5                   # How long to wait in seconds for a response from the PowerControllerViewer app\n  Frequency: 10                   # How often to post the state to the web viewer app (in seconds)\n\n\n# Optionally use this section to enable logging of output energy consumption data to CSV and the system state file\nOutputMetering:\n  Enable: True    # Set to True to enable logging of output energy consumption data\n  DataFile: logs/output_consumption_data.csv     # Record to CSV data file. Required\n  OutputsToLog:   # A list of outputs to log. These must have a meter associated with them (Outputs: [Item]: DeviceMeter field)\n    - Output: Pool Pump\n      DisplayName: Pool\n    - Output: Solar Heating\n      DisplayName: Solar\n      HideFromViewerApp: True   # If True, exclude this output from the viewer app's metering display page\n    - Output: Hot Water Heater\n      DisplayName: Hot Water\n    - Output: Tesla\n    - Output: \"EM1.1 Living &amp; Beds\"\n      DisplayName: \"Living &amp; Beds\"\n    - Output: \"EM1.2 Kitchen &amp; Laundry\"\n      DisplayName: \"Kitchen &amp; Laundry\"\n\n\n# Optionally enable temperature probe logging. The temperature probes must be defined in the Shelly device configuration above.\nTempProbeLogging:\n    Enable: True\n    Probes:   # A list of temp probes to monitor.\n      - Name: Temp Pool Water\n        DisplayName: Pool Water\n        Colour: Blue  # Colour to use when charting this probe\n      - Name: Temp Roof\n      - Name: Temp Solar Return\n        HideFromViewerApp: True      # If True, probe will be logged in CSV file but hidden from the PowerControllerViewer app\n    LoggingInterval: 30  # Log temp probe readings every N minutes\n    LastReadingWithinMinutes: 180  # Only log readings that have been updated within this number of minutes. 0 to disable.\n    SavedStateFileMaxDays: 7  # Number of days to keep in the data in the system state file. Try to keep this as low as possible to reduce file size. 0 to disable.\n    HistoryDataFile: temp_probe_history.csv  # Leave blank to disable logging to a CSV file.\n    HistoryDataFileMaxDays: 90  # Maximum number of days to keep in the history data file.  0 to disable.\n    Charting:   # This contains settings for generating temperature charts for the PowerControllerViewer website.\n      Enable: True\n      Charts:\n        - Name: \"Pool Temps\"\n          Probes:\n            - Temp Pool Water\n            - Temp Solar Return\n          DaysToShow: 30\n        - Name: \"Roof Temp\"\n          Probes:\n            - Temp Roof\n          DaysToShow: 30\n\n\n# Optionally use this section to configure integration with your UPS to monitor its runtime and battery charge levels. See README for more details.\nUPSIntegration:\n  - Name: APC UPS\n    Script: shell_scripts/apc_ups_runtime.sh\n    MinRuntimeWhenDischarging: 300   # Minimum runtime remaining in seconds to when UPS is discharging to consider the UPS as \"healthy\". \n    MinChargeWhenDischarging: 10   # Minimum charge remaining in percent when discharging to consider the UPS as \"healthy\".\n    MinRuntimeWhenCharging:     # Minimum runtime remaining in seconds to when UPS is charging to consider the UPS as \"healthy\". \n    MinChargeWhenCharging: 80   # Minimum charge remaining in percent when charging to consider the UPS as \"healthy\".\n\n\n# Optionally use this section to specify the geographic location and timezone of your installation. This is used to determine the dawn and dusk times for scheduled events.\nLocation:\n  Timezone: Europe/London     # See https://en.wikipedia.org/wiki/List_of_tz_database_time_zones\n\n\n# Optionally use this sectionto configure integration with the TeslaMate database to import Tesla charging session data\nTeslaMate:\n  Enable: True           # Set to True to enable integration with the TeslaMate database\n  RefreshInterval: 10     # How often to refresh the TeslaMate data (in minutes)\n  Host: 127.0.0.1         # The host address of the TeslaMate database (or use the TESLAMATE_DB_HOST environment variable)\n  Port: 5432              # The port number of the TeslaMate database (or use the TESLAMATE_DB_PORT environment variable)\n  DatabaseName: teslamate # The name of the TeslaMate database (or use the TESLAMATE_DB_NAME environment variable)\n  DBUsername: teslamate   # The username to connect to the TeslaMate database (or use the TESLAMATE_DB_USER environment variable)\n  DBPassword: &lt;Your password here&gt;  # The password to connect to the TeslaMate database (or use the TESLAMATE_DB_PASSWORD environment variable)\n\n</code></pre>"},{"location":"configuration/sections/amber_api/","title":"Configuration file - AmberAPI section","text":"<p>Integration with the Amber Electric API to download real time energy prices for your home. To setup this section, you need to have an energy provider account with Amber Electric. Login to https://app.amber.com.au/developers/ and generate a new token to get your API key.</p> Key Description APIKey Your Amber API key for used authentication (see above). Alternatively, you can set this via the set the AMBER_API_KEY environment variable. Mode Operating mode for the Amber integration:Live: Attempt to download pricesOffline: Pretend Amber API is offline, use cached prices. Useful for testing. Disabled: Use the relevant operating schedule for prices. APIURL Base URL for API requests. This the servers URL on the Amber developer's page, currently: https://api.amber.com.au/v1 Timeout Number of seconds to wait for Amber to respond to an API call. MaxConcurrentErrors Send an email notification if we get this number of concurrent errors from Amber. RefreshInterval How often to refresh the pricing data from Amber (in minutes). UsageDataFile Set to the name of a CSV file to log hourly energy usage and costs as reported by Amber. UsageMaxDays Maximum number of days to keep in the usage data file. PricesCacheFile The name of the file to cache Amber pricing data."},{"location":"configuration/sections/email/","title":"Configuration file - Email section","text":"<p>Use this section here you want to be emailed when there's a critical error or excessive energy use.</p> Key Description EnableEmail Set to True if you want to allow the PowerController to send emails. If True, the remaining settings in this section must be configured correctly. SMTPServer The SMTP host name that supports TLS encryption. If using a Google account, set to smtp.gmail.com SMTPPort The port number to use to connect to the SMTP server. If using a Google account, set to 587 SMTPUsername Your username used to login to the SMTP server. Alternatively, set the SMTP_USERNAME environment variable. If using a Google account, set to your Google email address. SMTPPassword The password used to login to the SMTP server. Alternatively, set the SMTP_PASSWORD environment variable. If using a Google account, create an app password for the PowerController first. SubjectPrefix If set, the PowerController will add this text to the start of any email subject line for emails it sends."},{"location":"configuration/sections/files/","title":"Configuration file - Files section","text":"<p>Location of log and system state files.</p> <p>Note: Required keys are shown in bold.</p> Key Description SavedStateFile JSON file name to store the Power Controller's device current state and history. LogfileName A text log file that records progress messages and warnings. LogfileMaxLines Maximum number of lines to keep in the log file. If zero, file will never be truncated. LogfileVerbosity The level of detail captured in the log file. One of: none; error; warning; summary; detailed; debug; all. ConsoleVerbosity Controls the amount of information written to the console. One of: error; warning; summary; detailed; debug; all. Errors are written to stderr all other messages are written to stdout."},{"location":"configuration/sections/general/","title":"Configuration file - General section","text":"<p>General settings for the Power Controller application.</p> Key Description Label The label (name) that your installation. Used in the email subject and web viewer app PollingInterval Number of seconds to sleep between each check of the run plan and possible changes to outputs. Recommended 30 seconds or more. ReportCriticalErrorsDelay Some critical errors can trigger email notifications - for example the AmberAPI not responding. This is the time in minutes for an issue to persist before we send an email notification. Leave blank to disable. PrintToConsole Print some basic information to the console during startup and operation DefaultPrice A default price to use if the Amber API is not available and there is no schedule price defined"},{"location":"configuration/sections/heartbeat_monitor/","title":"Configuration file - HeartbeatMonitor section","text":"<p>Integration with a Better Uptime heartbeat monitor to monitor uptime of the application.</p> Key Description Enable Set to True to enable integration with the Heartbeat monitoring service. WebsiteURL Each time the app runs successfully, you can have it hit this URL to record a heartbeat. This is optional. If the app exist with a fatal error, it will append /fail to this URL. HeartbeatTimeout How long to wait for a response from the website before considering it down in seconds. Frequency How often to post the state to the heartbeat monitor (in seconds)."},{"location":"configuration/sections/location/","title":"Configuration file - Location section","text":"<p>Specify the geographic location and timezone of your installation. This is used to determine the dawn and dusk times for schedules that use this feature. </p> <p>You can specify your location in one of three ways - device location (IP goecoding); Google Maps URL or manual. All three options also require your timezone (see this page for a list ). </p>"},{"location":"configuration/sections/location/#shelly-device-location","title":"Shelly Device Location","text":"<p>Use a Shelly device's location (using IP lookup) by specifing the device name in the UseShellyDevice field.</p> <pre><code>Location:\n    Timezone: Europe/London\n    UseShellyDevice: Shelly Pool 1\n</code></pre>"},{"location":"configuration/sections/location/#google-maps-url","title":"Google Maps URL","text":"<p>Use a Google Maps URL to extract the location - specify the GoogleMapsURL field and the Timezone field.</p> <pre><code>Location:\n    Timezone: Europe/London\n    GoogleMapsURL: https://www.google.com/maps/place/Buckingham+Palace/@51.4993124,-0.1353157,14.92z\n</code></pre>"},{"location":"configuration/sections/location/#manual","title":"Manual","text":"<p>Manually specify the latitude and longitude - specify the Timezone, Latitude and Longitude fields.</p> <pre><code>Location:\n    Timezone: Europe/London\n    Latitude: 51.4993124\n    Longitude: -0.1353157\n</code></pre>"},{"location":"configuration/sections/operating_schedules/","title":"Configuration file - OperatingSchedules section","text":"<p>Define the operating schedules for your devices. These are used to determine when a device is allowed to run when configured for Schedule mode. </p> <p>Note: Required keys are shown in bold.</p> Key Description Name A name for this schedule - used in the Outputs section. Windows A list of one or more StartTime / StopTime events for this schedule. Each window can have the following elements.... Window Paramater Description StartTime The start time in miliary format, for example \"13:30\". Must be enclosed in double quotes. EndTime The start time in miliary format, for example \"17:30\". Must be enclosed in double quotes. DaysOfWeek Days of the week this window applies to - Mon, Tue, Wed, Thu, Fri, Sat, Sun or All. Multiple days can be specified separated by commas. Price The average eletricity price in c/kWh for energy during this window. Used to forecast costs when running on a schedule rather than Amber prices."},{"location":"configuration/sections/output_metering/","title":"Configuration file - OutputMetering section","text":"<p>Enable logging of output energy consumption data to a CSV file and the system state file. You can list any output here that has an energy meter.</p> <p>If the web viewer app is enabled then usage summaries are shown for each output for a variety of usage periods including custom.</p> <p>Note: The section is optionaly, but if you use it, the required keys below are shown in bold.</p> Key Description Enable Set to False to disable all output meter logging. DataFile The CSV file to log to. DataFileMaxDays Maximum number of days to keep in the CSV data file. Set to -1 for unlimited. OutputsToLog A list of outputs to include in the logs. Each entry can include:Output: The name of the output. Must match a Outputs: [item]: Name entry.DisplayName: Optionally use this alternative name in the CSV file and in the web view app.HideFromViewerApp: If True, log this output int he CSV file but don't show it in the viewer app."},{"location":"configuration/sections/output_sequences/","title":"Configuration file - OutputSequences section","text":"<p>Define the sequence of events that must happen to turn an Output On or Off. In our example config file, turning on our pool solar heating booster pump requires that we first turn on an actuator valve, wait for a minute and then turn on the solar booster pump. </p> <p>Note: The section is optionaly, but if you use it, the required keys below are shown in bold.</p> Key Description Name A name for this sequence. Description A description for this sequence. Timeout How long to wait for all the steps in the sequence to complete. Steps A list of steps for this sequence - see below. <p>Each step entry in the sequence can include the following parameters:</p> Key Description Type What type of step is this. One of:CHANGE_OUTPUT - Change an output to On or Off.SLEEP - Sleep for X seconds before the next step.GET_LOCATION - Get the geo-location data from the specified Shelly device. REFRESH_STATUS - Refresh the status of all Shelly devices. OutputIdentity If the step type is CHANGE_OUTPUT, set the name of the output here. This must be an output named in the ShellyDevices: Devices: [Device]: Outputs section. DeviceIdentity If the step type is Define a sequence of actions to perform on outputs when turning On or off, set the name of the Shelly device here. This must be a device named in the ShellyDevices: Devices section. Seconds If the step type is Define a sequence of actions to perform on outputs when turning On or off, use this to specify the sleep time. State If the step type is Define a sequence of actions to perform on outputs when turning On or off, set this to True to turn the output on, False to turn it off. Retries How many retry attempts to make on this step before giving up. RetryBackoff How many seconds to wait between retry attempts."},{"location":"configuration/sections/outputs/","title":"Configuration file - Outputs section","text":"<p>This is wehre the action happens. This section configures your switched outputs and energy meters and controls how they behave. You must define at least one Output for the app to work.</p> <p>There are three fundametal types of Output device.</p> <ol> <li>shelly: This the default - a specific output relay of a Shelly Smart switch. shelly type of outputs are used to switch electrical devices on and off.</li> <li>meter: A Shelly energy meter. This is used to  monitor and log energy usage for a electrical circuit. </li> <li>teslamate: A special type of energy meter that imports Tesla vehicle charging data from using TeslaMate. Requires the TeslaMate section to be properly configured.</li> </ol> <p>The Output device type is set via the Mode key. </p> <p>There's a lot of keys in this section, but not all are applicable to all types:</p> Setting shelly meter teslamate Name \u2713 \u2713 \u2713 Type \u2713 \u2713 \u2713 DeviceOutput \u2713 \u2713 Mode \u2713 \u2713 \u2713 Schedule \u2713 \u2713 \u2713 ConstraintSchedule \u2713 AmberChannel \u2713 \u2713 \u2713 CarID \u2713 DaysOfHistory \u2713 \u2713 \u2713 MinHours \u2713 MaxHours \u2713 TargetHours \u2713 MonthlyTargetHours \u2713 MaxShortfallHours \u2713 MaxBestPrice \u2713 MaxPriorityPrice \u2713 DatesOff \u2713 DeviceMeter \u2713 \u2713 MaxDailyEnergyUse \u2713 \u2713 DeviceInput \u2713 DeviceInputMode \u2713 StopOnExit \u2713 MinOnTime \u2713 MinOffTime \u2713 ParentOutput \u2713 TurnOnSequence \u2713 TurnOffSequence  \u2713 MaxAppOnTime \u2713 MaxAppOffTime \u2713 UPSIntegration \u2713 PowerOnThresholdWatts \u2713 PowerOffThresholdWatts \u2713 MinEnergyToLog \u2713 HideFromWebApp \u2713 \u2713 \u2713 HideFromViewerApp \u2713 \u2713 \u2713 TempProbeConstraints \u2713 <p>The complete list of keys applicable in this section are as follows:</p> <p>Note: Required keys are shown in bold.</p> Key Description Name A name for this output - used in the web interface. Type Configures what type of output this is as decribed above:shelly: A fully functional Shelly smart switch output. meter: A Shelly energy meter. teslamate: Imports Tesla charging data from using TeslaMate. DeviceOutput Specify the Shelly device output that controls this device - must match a Name in the ShellyDevices: Devices: Outputs section. Mode Operating mode:BestPrice: Run for target hours at best priceSchedule: Run according to schedule only. Schedule The operating schedule to use when in Schedule mode - must match a Name in the OperatingSchedules section. ConstraintSchedule An constraint schedule that limits when the output can run, even in BestPrice mode. AmberChannel The Amber pricing channel to use for this device, typically either general or controlledLoad. CarID The numeric ID of the Tesla you want to import data for. Leave blank to get data for all vehicles. You can get the CarID from the URL parameter car_id= in the TeslaMate \"charges\" dashboard. DaysOfHistory How many days of history to keep for this device MinHours Minimum number of hours to run each day MaxHours Maximum number of hours to run each day TargetHours Target number of hours to run each day. Set to -1 to run for all hours comply with the price and/or schedule constaints. MonthlyTargetHours Override the TargetHours for a specific month of the year MaxShortfallHours Maximum number of shortfall hours we can carry forward from previous days. MaxBestPrice The maximum price to run at when in BestPrice mode. MaxPriorityPrice The maximum price to run when we haven't run for the minimum number of hours (MinHours) yet. DatesOff Optional list of date ranges when the output should not run. A list of StartDate and EndDate pairs. Dates are in the format yyyy-mm-dd DeviceMeter The Shelly device meter to use to track energy usage - must match a Name in the ShellyDevices: Devices: Meters section MaxDailyEnergyUse Maximum energy use expected in Wh per day. An email warning will be sent if this is exceeded. DeviceInput The Shelly device input to used override the state of the output - must match a Name in the ShellyDevices: Devices: Inputs section DeviceInputMode If a DeviceInput is specified, this controls how is is used. Ignore: Ignore the state of the inputs.TurnOn: Turn output on if input is off. TurnOff: Turn output off if input is on. StopOnExit If True, attempt to turn off the outputs when the application exits MinOnTime Minimum minutes to stay on once turned on. MinOffTime Minimum minutes to stay off (prevent rapid cycling). Cannot be set if MaxffTime is set. MaxOffTime Maximum minutes to stay off. Cannot be set if MinffTime is set. Recommend using this in conjunction with MinOnTime, otherwise if the run plan requires the output to be off, it turn off again immediatly after turning on due to this trigger. ParentOutput This output is slaved to the designated parent output. In addition to the other criteria defined for this output, it'll only run when the parent is running. TurnOnSequence Name of the output sequence to run when turning on this output. The sequence name must be defined in the OutputSequences section TurnOffSequence Name of the output sequence to run when turning off this output. MaxAppOnTime If we turned this output on via the app, revert to auto after this number of minutes. MaxAppOffTime If we turned this output off via the app, revert to auto after this number of minutes. UPSIntegration This section must contain two entries:UPS: The name of the UPS, as defined in the UPSINtegrations section (see below). ActionIfUnhealthy: One of: TurnOn or TurnOff. PowerOnThresholdWatts Only applies to meter style outouts. The minimum power draw before we start recording energy use (output is considered \"On\"). PowerOffThresholdWatts Only applies to meter style outouts. The maximum power draw before this output will be considered \"Off\". MinEnergyToLog If a device run is logged with less than this number of Watts, the entry will be discarded. HideFromWebApp If True, this output will not be shown in the built-in web app. HideFromViewerApp If True, this output will not be shown in the PowerControllerViewer app. TempProbeConstraints List of temperature probe constraints that must be met for the output to run. Each entry must include:TempProbe: The name of the temperature probe that constrains this output. Must be defined in the ShellyDevices: Devices: TempProbes section.Condition: Either GreaterThan or LessThanTemperature: The threshold temperature on degress C. <p>Take a look at the example configuration file for some real world examples.</p>"},{"location":"configuration/sections/shelly_devices/","title":"Configuration file - ShellyDevices section","text":"<p>In this section you can configure one or more Shelly Smart switches, one of which will be used to control or meter your electrical device. Here's an example of a section of yaml file configuration for 3 Shelly devices:</p> <pre><code>ShellyDevices:\n  AllowDebugLogging: True\n  ResponseTimeout: 5\n  RetryCount: 1\n  RetryDelay: 2\n  PingAllowed: True\n  SimulationFileFolder: simulation_files\n  # Enable or disable the webhook listener\n  WebhooksEnabled: True\n  # IP to listen for webhooks on. This should be the IP address of the machine running the app. Defaults to 0.0.0.0\n  WebhookHost: 192.168.86.32\n  # Port to listen for webhooks on. Defaults to 8787.\n  WebhookPort: 8787\n  # The URI path that webhooks will post to.\n  WebhookPath: /shelly/webhook  \n  # The webhooks to install by default\n  DefaultWebhooks:\n    Inputs:\n      - input.toggle_on\n      - input.toggle_off\n      - input.button_push\n    Outputs:\n      - switch.on\n      - switch.off\n  Devices:\n    - Name: Downstairs Lights\n      Model: Shelly2PMG3\n      Hostname: 192.168.1.23\n      ID: 100\n      Inputs:\n        - ID: 101\n          Name: \"Living Room Switch\"\n          Webhooks: True\n        - ID: 102\n          Name: \"Kitchen Switch\"\n          Webhooks: True\n      Outputs:\n        - ID: 111\n          Name: \"Living Room Relay\"\n        - ID: 112\n          Name: \"Kitchen Relay\"\n      TempProbes:\n        - Name: \"Outside Temp\"\n        - Name: \"Inside Temp\"\n    - Name: Outside Lights\n      Model: Shelly2PMG3\n      Hostname: 192.168.1.25\n      ID: 200\n      Inputs:\n        - ID: 201\n          Name: \"Patio Switch\"\n        - ID: 202\n          Name: \"Car Port Switch\"\n      Outputs:\n        - ID: 211\n          Name: \"Patio Relay\"\n        - ID: 212\n          Name: \"Car Port Relay\"\n    - Name: Testing\n      Model: ShellyPlus1PM\n      Simulate: True\n      Outputs:\n        - Name: \"Test Switch\"\n      Meters:\n        - Name: \"Test Meter\"\n\n</code></pre> <p>The entries are used as follows:</p> Parameter Description ResponseTimeout How long to wait (in seconds) before timeing out when making an API call or ping. RetryCount How many retries to make if an API call times out. RetryDelay How long to wait (in seconds) between retry attempts. PingAllowed Set to False if ICMP isn't suppported by the route to your devices. SimulationFileFolder The folder to save JSON simulation files in. WebhooksEnabled Enable or disable the webhook listener WebhookHost IP to listen for webhooks on. This should be the IP address of the machine running the app. Defaults to 0.0.0.0. WebhookPort Port to listen for webhooks on. Defaults to 8787. WebhookPath The URI path that webhooks will post to. DefaultWebhooks The webhooks to install by default. See the example above for format. Look at the SupportedWebhooks key of an initialised Shelly device to see which webhook events your device supports. Use the  get_device() call to get a device object. Devices A list of dicts, each on defining a Shelly device. - see below <p>The Devices key in the configuration block supports the following keys :</p> Parameter Description Name Your name for this device Model The model Shelly ID for this device. See the Shelly Models List for more. Hostname The network IP address or hostname for this device. ID Your numeric ID for this device. Simulate Set this to True if you don't have access to the device but still want to test your code. When True, this device will be in 'simulation' mode. Rather than make API calls to the device, the state will be written to and read from a local json file (with the same name as your Name entry). You can modify some of the values in this file to test your code. ExpectOffline If set to True, we can expect this device to be offline at times. No warnings will be issued when this happens Inputs A list of dicts defining the inputs (if any) for this device. This section is optional but if defined, the number of entries must match the number of inputs supported by this model. For each input, define a Name and/or an ID. Optionally, add a Webhooks: True entry here to install the default webhooks on this input. Outputs A list of dicts defining the outputs (if any) for this device. This section is optional but if defined, the number of entries must match the number of outputs supported by this model. For each output, define a Name and/or an ID. Optionally, add a Webhooks: True entry here to install the default webhooks on this input. Meters A list of dicts defining the meters (if any) for this device. Note that depending on the devices, the actual meters might be part of the output or seperate energy meters (EM1 API calls). Either way, in this class meters are reported seperately from outputs. This section is optional but if defined, the number of entries must match the number of meters supported by this model. For each meter, define a Name and/or an ID.  Optionally, use the MockRate key to set a Watts / second metering rate for this meter when the device is in Simulation mode. TempProbes A list of dicts defining the temperature probes connected to a Shelly Add-on that's plugged into this device. For each one you must define a Name key that matches the name given to the probe in the app (see below).  Optionally, use the RequiresOutput key to specify the name of an output device that constrains this temp probe. If set, the temperature reading will only be updated when this output is on. <p>Notes:</p> <ul> <li>Either a Device Name or a Device ID must be supplied.</li> </ul>"},{"location":"configuration/sections/shelly_devices/#more-information","title":"More information","text":"<p>See the Shelly Getting Started guide for details on how to configure this section.</p>"},{"location":"configuration/sections/temp_probe_logging/","title":"Configuration file - TempProbeLogging section","text":"<p>Log temperature probe readings to the system state JSON file and/or a CSV file. </p> <p>Temperature readings can be aquired from two sources:</p> <ol> <li>One or more ds18b20 digital temperature probes connected to a Shelly Addon device (see Shelly Setup for more information. )</li> <li>An internal temperature probe that's included in most modern Shelly smart switches.</li> </ol> <p>Note: The section is optionaly, but if you use it, the required keys below are shown in bold.</p> Key Description Enable Set to True or False Probes A list of temp probe names, as defined in the ShellyDevices: Devices: [Device]: TempProbes section. You can optionally add:DisplayName: Name to be used in logging.Colour: The colour to use when charting this probe.HideFromViewerApp: If True, ony log to the CSV file. LoggingInterval Log temp probe readings every N minutes LastReadingWithinMinutes Only log readings that have been updated within this number of minutes. 0 to disable. SavedStateFileMaxDays Number of days to keep in the data in the system state file. Try to keep this as low as possible to reduce file size. 0 to disable. HistoryDataFile Leave blank to disable logging to a CSV file. HistoryDataFileMaxDays Maximum number of days to keep in the history data file.  0 to disable. Charting Optionally use this section to configure how the PowerControllerViewer web app charts temperature reading history. The requires the following sub-keys:Enable: Set to true to enable charting.Charts: A list of chart configurations - see below. <p>The Charting: Charts section is a list of entries, each one defining a specifc chart to be displayed by the PowerControllerViewer app. Each entry requires the following </p> Key Description Name The name of this chart. This will be used for the chart title. Probes: A list of the temperature probe(s) to include in this chart. DaysToShow How many days of data to show in this chart. This must be equal to or less than the HistoryDataFileMaxDays figure. <p>Here's an example:</p> <pre><code>    ...\n    Charting:\n      Enable: True\n      Charts:\n        - Name: \"Pool Temps\"\n          Probes:\n            - Temp Pool Water\n            - Temp Solar Return\n          DaysToShow: 30\n        - Name: \"Roof Temp\"\n          Probes:\n            - Temp Roof\n          DaysToShow: 30\n</code></pre>"},{"location":"configuration/sections/teslamate/","title":"Configuration file - TeslaMate section","text":"<p>This can be used to import Tesla charging data from a local network instance of TeslaMate .  </p> <p>If you want to limit data imports to home charging, first set a geofence name in the TeslaMaste dashboard (Home &gt; Dashboards &gt; TeslaMate &gt; Charges) and then set this geofence name in the GeofenceName config parameter.</p> Key Description Enable Set to True to enable integration with the TeslaMate database. RefreshInterval How often to refresh the TeslaMate data (in minutes). Host The host address of the TeslaMate database (or use the TESLAMATE_DB_HOST environment variable). Port The port number of the TeslaMate database (or use the TESLAMATE_DB_PORT environment variable). DatabaseName The name of the TeslaMate database (or use the TESLAMATE_DB_NAME environment variable). DBUsername The username to connect to the TeslaMate database (or use the TESLAMATE_DB_USER environment variable). DBPassword The password to connect to the TeslaMate database (or use the TESLAMATE_DB_PASSWORD environment variable)."},{"location":"configuration/sections/ups_integration/","title":"Configuration file - UPSIntegration section","text":"<p>Define one or more UPS units that can modify the behaviour of an Output. </p> <p>In the context of the PowerController app a UPS is considered \"healthy\" or \"unhealthy\". An unhealthy UPS -  - Is discharging and it's current battery charge and/or remaining runtime is below a set threshold (e.g. charge below 10%)  - Is charging and it's current battery charge and/or remaining runtime is below a set threshold (e.g. charge below 90%)</p> <p>Use this in conjunction with the UPSIntegration: entry in the Outputs section to dictate how an unhealthy UPS will override the state of the output.</p> <p>Note: The section is optionaly, but if you use it, the required keys below are shown in bold.</p> Key Description Name A name for this UPS. You will reference this name in the Outputs: UPSIntegration: UPS: entry. Script The shell script to run to get this current state of the UPS. The script must return the information in JSON format to stdout. Can include a realtive or absolute path. MinRuntimeWhenDischarging Minimum runtime remaining in seconds to when UPS is discharging to consider the UPS as \"healthy\". MinChargeWhenDischarging Minimum charge remaining in percent when discharging to consider the UPS as \"healthy\". MinRuntimeWhenCharging Minimum runtime remaining in seconds to when UPS is charging to consider the UPS as \"healthy\". MinChargeWhenCharging Minimum charge remaining in percent when charging to consider the UPS as \"healthy\". <p>The UPS script should return a JSON object with the following format:</p> <pre><code>{\n    \"timestamp\": \"2024-06-01T12:00:00Z\",\n    \"battery_state\": \"charging\",\n    \"battery_charge_percent\": 85,\n    \"battery_runtime_seconds\": 600\n}\n</code></pre> <p>Where:</p> <ul> <li>battery_state is one of \"charging\", \"discharging\" or \"charged\"</li> <li>battery_charge_percent is a number between 0 and 100</li> <li>battery_runtime_seconds is the remaining runtime in seconds.</li> </ul> <p>battery_charge_percent or battery_runtime_seconds can be null, but not both. See the shell_scripts/apc_ups_runtime.sh script as an example script for a retail APC UPS.</p>"},{"location":"configuration/sections/viewer_website/","title":"Configuration file - ViewerWebsite section","text":"<p>Use this section to configure integration with the PowerControllerViewer app - see https://github.com/NickElseySpelloC/PowerControllerViewer</p> Key Description Enable Set to True to enable integration with the PowerControllerViewer app. BaseURL The base URL of the PowerControllerViewer app. AccessKey The access key for the PowerControllerViewer app. Alternatively, set the VIEWER_ACCESS_KEY environment variable. APITimeout How long to wait in seconds for a response from the PowerControllerViewer app. Frequency How often to post the state to the web viewer app (in seconds)."},{"location":"configuration/sections/website/","title":"Configuration file - Website section","text":"<p>Settings for the built-in web server that provides a web interface to view and control the outputs.</p> Key Description HostingIP The IP address to host the web server on. Use 0.0.0.0 to listen on all interfaces (the default). Port The port to host the web server on. PageAutoRefresh How often to refresh the web page (in seconds). Set to 0 to disable auto-refresh. DebugMode Enable or disable debug mode for the web server (should be False in production). AccessKey An access key to secure the web interface. Alternatively, set the WEBAPP_ACCESS_KEY environment variable. Leave blank to disable access control."},{"location":"installation/","title":"Getting Started and Installation","text":"<p>PowerController is primarily designed to be run on either a Linux system, A RaspberryPi or an Apple Mac (Intel or Apple Silicon). Earlier versions have been tested on Windows 11 and since this is a Python application, this should still work, but the installation steps below will need to be adjusted.</p> <p>Installation comes in several phases: </p> <ol> <li>Install the Prerequisites (Python, git, UV)</li> <li>Prepare your Shelly devices</li> <li>Install the PowerController application</li> <li>Configure the PowerController application</li> </ol>"},{"location":"installation/#next-step-install-the-prerequisites","title":"Next Step &gt;&gt; Install the Prerequisites","text":""},{"location":"installation/install_app/","title":"Installing the PowerController Application","text":"<p>The application installation instructions are generally the same for Linux, macOS and CentOS (RaspberryPi). Start a new terminal window on your target system and select parent folder that we'll create the installation folder in. In our example below, we'll use ~/apps folder for our user nick (/home/nick/apps)</p>"},{"location":"installation/install_app/#step-1-validate-that-the-prerequisites-are-properly-installed","title":"Step 1: Validate that the prerequisites are properly installed","text":"<p>Run the following commands. If any of them fail, or the python version is less than 3.13.0 please go back and review the prerequisite installation section again.</p> <pre><code>python3 --version\ngit --version\nuv --version\n</code></pre>"},{"location":"installation/install_app/#step-2-download-the-app-from-github","title":"Step 2: Download the app from GitHub","text":"<p>Create a folder for the app</p> <pre><code>cd ~/apps\nmkdir PowerController\ncd PowerController\n</code></pre> <p>Clone the app from GitHub</p> <pre><code>git clone https://github.com/NickElseySpelloC/PowerController.git .\n</code></pre> <p>Use UV to initialise the application and download all the supporting libraries</p> <pre><code>uv sync\n</code></pre> <p>Watch the uv sync command and make sure there are no errors reported. If all's well, activate the Python virtual environment and make sure we're using the right version of Python:</p> <pre><code>source .venv/bin/activate\nuv python pin 3.13\n</code></pre>"},{"location":"installation/install_app/#step-3-create-the-default-config-file","title":"Step 3: Create the default config file","text":"<p>An example configuration file has been provided for you in the application's root folder (config_example.yaml). Use this as a starting point for your config file:</p> <pre><code>cp config_example.yaml config.yaml\n</code></pre>"},{"location":"installation/install_app/#step-4-create-a-env-file-for-secure-credentials","title":"Step 4: Create a .env file for secure credentials","text":"<p>If you plan on using the following features: - Integration with Amber Electric for energy pricing - Email notification of application errors or excessive energy use - Secure integration with the PowerControllerViewer app - Stronger protection for the PowerController web application - Tesla charging integration</p> <p>Then we recommend creating a .env file to hold passwords and API keys. For now, let's create a file and store your email account SMTP username and password:</p> <pre><code>nano .env\n\n\n# In nano, create the following entries, save and exit:\nSMTP_USERNAME=&lt;SMTP username here&gt;\nSMTP_PASSWORD=&lt;SMTP password here&gt;\n</code></pre> <p>You're now ready to edit config.yaml and setup the configuration for your installation.</p>"},{"location":"installation/install_app/#next-step-configure-the-app","title":"Next Step &gt;&gt; Configure the App","text":""},{"location":"installation/prerequisites/","title":"Installing the Prerequisites","text":"<p>The prerequisites for the PowerController application are:</p> <ol> <li>Python v3.13</li> <li>UV package manager</li> </ol> <p>We'll step you through each of these in turn:</p>"},{"location":"installation/prerequisites/#step-1-checking-and-installing-python-v313","title":"STEP 1: Checking and installing Python v3.13","text":"<p>Check to see which version of Python is installed:</p> <pre><code>python3 --version\n</code></pre> <p>If Python 3.13 is installed, you should see something like:</p> <pre><code>Python 3.13.x\n</code></pre> <p>If the command is not found, or the version is lower than 3.13, install python3 using one of the sections below</p>"},{"location":"installation/prerequisites/#installing-python-v313-on-linux","title":"Installing Python v3.13 on Linux","text":"<p>We'll use apt to install Python 3.13 on Linux</p> <pre><code>sudo apt update\nsudo apt install python3.13 python3.13-venv python3.13-dev\n</code></pre>"},{"location":"installation/prerequisites/#installing-python-v313-on-macos","title":"Installing Python v3.13 on macOS","text":"<p>We'll use Homebrew to install Python 3.13 on a Mac</p> <p>Check if Homebrew is installed</p> <pre><code>brew --version\n</code></pre> <p>If Homebrew is not installed, install it with:</p> <pre><code>/bin/bash -c \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\"\n</code></pre> <p>After installation, restart your terminal.</p> <p>Install Python 3.13</p> <pre><code>brew update\nbrew install python@3.13\n</code></pre> <p>Ensure Python 3.13 is being used</p> <pre><code>brew link python@3.13 --force\n</code></pre> <p>Verify that v3.13 is not the default:</p> <pre><code>python3 --version\n</code></pre>"},{"location":"installation/prerequisites/#installing-python-v313-on-a-raspberrypi","title":"Installing Python v3.13 on a RaspberryPi","text":"<p>As at the time of writing, Python 3.13 compiled binaries aren't yet available for the Pi, so you will need to compile them from the source code using this guide.</p>"},{"location":"installation/prerequisites/#step-2-install-git","title":"STEP 2: Install git","text":"<p>git is needed to download the PowerController app from GitHub. Check if git is installed</p> <pre><code>git --version\n</code></pre> <p>If it's not installed, follow the steps below.</p>"},{"location":"installation/prerequisites/#installing-git-on-linux-and-raspberrypi","title":"Installing git on Linux and RaspberryPi","text":"<pre><code>sudo apt update\nsudo apt install git\n</code></pre>"},{"location":"installation/prerequisites/#installing-git-on-macos","title":"Installing git on macOS","text":"<pre><code>brew install git\n</code></pre>"},{"location":"installation/prerequisites/#step-3-install-the-uv-package-manager","title":"STEP 3: Install the UV package manager","text":"<p>uv is extremely fast and replaces tools like pip, venv, and pip-tools.</p>"},{"location":"installation/prerequisites/#installing-uv-on-linux-and-raspberrypi","title":"Installing UV on Linux and RaspberryPi","text":"<pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh\n</code></pre> <p>Restart your terminal session, then verify:</p> <pre><code>uv --version\n</code></pre>"},{"location":"installation/prerequisites/#installing-uv-on-macos","title":"Installing UV on macOS","text":"<pre><code>brew install uv\n\n# Verify installation:\nuv --version\n</code></pre>"},{"location":"installation/prerequisites/#ensuring-uv-is-on-your-path","title":"Ensuring uv is on Your PATH","text":"<p>If uv installs but the command is not found, add this to your shell profile (~/.bashrc, ~/.zshrc, etc.):</p> <pre><code>export PATH=\"$HOME/.local/bin:$PATH\"\n</code></pre> <p>Then reload:</p> <pre><code># Reload ZShell\nsource ~/.zshrc\n\n# Reload bash\nsource ~/.bashrc\n</code></pre>"},{"location":"installation/prerequisites/#next-step-setup-your-shelly-devices","title":"Next Step &gt;&gt; Setup your Shelly devices","text":""},{"location":"installation/raspberry_pi_python/","title":"Build and Install Python 3.13 on a RaspberryPi","text":"<p>PowerController requires Python v3.13 or later. As at the time of writing, compiled binaries aren't yet available for the Pi, so you will need to compile them from the source code. We recommend a Pi with a good amount of free memory and swap space. </p>"},{"location":"installation/raspberry_pi_python/#check-available-ram-and-swap","title":"Check available RAM and swap","text":"<pre><code>free -h\n</code></pre> <p>If available RAM is low (&lt;100 MB), consider increasing swap:</p> <pre><code>sudo dphys-swapfile swapoff\nsudo nano /etc/dphys-swapfile\n\n# Set CONF_SWAPSIZE=2048 (or higher)\nsudo dphys-swapfile setup\nsudo dphys-swapfile swapon\n</code></pre> <p>Now build python 3.13 from source. This will install Python as /usr/local/bin/python3.13.</p> <pre><code>sudo apt update\n\nsudo apt install -y make build-essential libssl-dev zlib1g-dev \\\n  libbz2-dev libreadline-dev libsqlite3-dev wget curl llvm \\\n  libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \\\n  libffi-dev liblzma-dev\n\ncd /usr/src\nsudo wget https://www.python.org/ftp/python/3.13.0/Python-3.13.0.tgz\nsudo tar xzf Python-3.13.0.tgz\n\ncd Python-3.13.0\nsudo ./configure --enable-optimizations\nsudo make -j $(nproc)\nsudo make altinstall\n</code></pre> <p>\u26a0\ufe0f Use make altinstall so you don\u2019t overwrite the system Python.</p>"},{"location":"installation/shelly_setup/","title":"Setup your Shelly devices","text":"<p>PowerController requires at least one Shelly device to operate. You can run the application in simulation mode for testing, but to actually control and/or meter an electrical device, you'll need at least one Shelly device installed and configured. Shelly make a wide range of home automation products. PowerController supports the majority of Shelly's smart switches and energy meters that support WiFi or Ethernet connectivity.</p> <ol> <li>Install your device(s) according to Shelly's installation instructions. <ul> <li>Get help from a licensed electrician if you're uncomfortable doing this work yourself. </li> <li>You must connect the device to your network via WiFi or Ethernet (PowerController doesn't support Bluetooth, Z-Wave or Zigbee only devices at this time)</li> </ul> </li> <li>Use the Shelly app to make sure the device is working as intended. </li> <li>Please do not create any Actions for the device (these might conflict with the app's control of the device).</li> <li>In the app, go to Settings &gt; Device Information and make a note of the following:<ul> <li>Device IP address (e.g. 192.168.86.21)</li> <li>Device Type (e.g. Shelly Plus 2 PM)</li> </ul> </li> <li>Lookup the device type in models library and make a note of the model identifier (e.g. ShellyPlus2PM). Here's the entry for our example:</li> </ol> <pre><code>    {\n      \"model\": \"ShellyPlus2PM\",\n      \"name\": \"Shelly Plus 2PM\",\n      \"url\": \"https://shelly-api-docs.shelly.cloud/gen2/Devices/Gen2/ShellyPlus2PM\",\n      \"generation\": 2,\n      \"protocol\": \"RPC\",\n      \"inputs\": 2,\n      \"outputs\": 2,\n      \"meters\": 2,\n      \"meters_seperate\": false,\n      \"temperature_monitoring\": true\n    },\n</code></pre>"},{"location":"installation/shelly_setup/#digital-temperature-probes","title":"Digital Temperature Probes","text":"<p>If you have a Shelly Add-on installed on your Shelly switch, then you can connect up to 5 ds18b20 probes to the add-on. You must setup the probe(s) as follows before adding the probe's name to the ShellyDevices:Device:TempProbes section of your config file:</p> <p>Once you have connected the Shelly Add-on to your Shelly smart switch and connected your DS18B20 temperature probes to the add on, you need to configure the probes in the mobile app:</p> <ol> <li>Go to the Shelly device you have installed the Add-on to and configure the add-on<ul> <li>Click Add-on peripherals section</li> <li>Change to Sensor Addon and then reboot if prompted</li> </ul> </li> <li>After reboot, go back to same tab and click Add Add-on Peripheral<ul> <li>Select Temperature (DS18B20)</li> <li>Select a probe listed from the automatic scan and click Add Peripheral</li> <li>Reboot when prompted</li> </ul> </li> <li>After reboot, go back to same tab and click the settings gear icon next to the newly added probe<ul> <li>Give the probe a name (important) - for example \"Roof Temp\"</li> <li>Optionally enable the 'extract peripheral as device' option (if you want it to appear as a seperate device on your dashboard</li> </ul> </li> <li>Repeat steps 2 and 3 for any other connected probes</li> </ol> <p>Now add these probe(s) to ShellyDevices:Device:TempProbes section of your config file, being sure to use exactly the same names as you used in the Shelly app.</p> <pre><code>ShellyDevices:\n  ...\n  Devices:\n    - Name: Downstairs Lights\n      Model: Shelly2PMG3\n      Hostname: 192.168.1.23\n      ...\n      TempProbes:\n        - Name: \"Roof Temp\"\n</code></pre>"},{"location":"installation/shelly_setup/#unsupported-device","title":"Unsupported device","text":"<p>If you've bought a Shelly smart switch or energy meter and are having problems getting it to work, you can try modifying the shelly_models.json file included with the sc_utility library to add or update your devie. Alternatively, please contact Nick Elsey for support.</p>"},{"location":"installation/shelly_setup/#next-step-install-powercontroller","title":"Next Step &gt;&gt; Install PowerController","text":""}]}