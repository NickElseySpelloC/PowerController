<!doctype html>
<!-- Generated by Claude Sonnet 4 -->
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ global_data.AppLabel }}</title>
  <style>
    body {
      font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif;
      margin: 16px;
    }

    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    button {
      padding: 10px 12px;
      border: none;
      border-radius: 999px;
      background: #eee;
      cursor: pointer;
    }

    button.active {
      background: #2ecc71;
      color: #fff;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
    }

    .on {
      background: #2ecc71;
      color: #fff;
    }

    .off {
      background: #e74c3c;
      color: #fff;
    }
  </style>
</head>
<body>
  <script id="global-data-json" type="application/json">
    {{ global_data | tojson | safe }}
  </script>
  <div id="output-list">
    {% for output_id, output in outputs.items() %}
    <div class="card" data-output-id="{{ output.id }}">
      <div class="row">
        <div>
          <div style="font-weight:600; margin-bottom:4px">{{ output.name }}</div>
          <div style="opacity:0.7;font-size:12px">
            Mode: <span class="mode-display">{{ output.mode.upper() }}</span>
            &nbsp;
            <span class="pill status-pill {{ 'on' if output.is_on else 'off' }}">
              {{ 'ON' if output.is_on else 'OFF' }}
            </span>
            &nbsp;
            {{ output.reason if output.reason else '' }}
          </div>
        </div>
        <div class="row">
          <button class="mode-btn {{ 'active' if output.mode == 'on' else '' }}" 
                  data-mode="on" 
                  onclick="setMode('{{ output.id }}', 'on')">On</button>
          <button class="mode-btn {{ 'active' if output.mode == 'off' else '' }}" 
                  data-mode="off" 
                  onclick="setMode('{{ output.id }}', 'off')">Off</button>
          <button class="mode-btn {{ 'active' if output.mode == 'auto' else '' }}" 
                  data-mode="auto" 
                  onclick="setMode('{{ output.id }}', 'auto')">Auto</button>
        </div>
      </div>
    </div>
    {% endfor %}
  <script>
    // Store global data from server
    const globalData = JSON.parse(document.getElementById('global-data-json').textContent);
    
    async function fetchOutputs() {
      const res = await fetch('/api/outputs');
      return await res.json();
    }

    async function setMode(id, mode) {
      try {
        await fetch(`/api/outputs/${id}/mode`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode })
        });
        // Update the UI immediately after successful API call
        updateOutputDisplay(id, mode);
      } catch (error) {
        console.error('Failed to set mode:', error);
      }
    }

    function updateOutputDisplay(outputId, newMode) {
      // Find the card for this output
      const card = document.querySelector(`[data-output-id="${outputId}"]`);
      if (!card) return;

      // Update mode display
      const modeDisplay = card.querySelector('.mode-display');
      if (modeDisplay) {
        modeDisplay.textContent = newMode.toUpperCase();
      }

      // Update button states
      const buttons = card.querySelectorAll('.mode-btn');
      buttons.forEach(btn => {
        const btnMode = btn.getAttribute('data-mode');
        if (btnMode === newMode) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    async function refreshAllOutputs() {
      try {
        const data = await fetchOutputs();
        
        // Update each output's display (data.outputs now contains the outputs)
        Object.values(data.outputs).forEach(output => {
          const card = document.querySelector(`[data-output-id="${output.id}"]`);
          if (!card) return;

          // Update mode display
          const modeDisplay = card.querySelector('.mode-display');
          if (modeDisplay) {
            modeDisplay.textContent = output.mode.toUpperCase();
          }

          // Update status pill
          const statusPill = card.querySelector('.status-pill');
          if (statusPill) {
            statusPill.className = `pill status-pill ${output.is_on ? 'on' : 'off'}`;
            statusPill.textContent = output.is_on ? 'ON' : 'OFF';
          }

          // Update button states
          const buttons = card.querySelectorAll('.mode-btn');
          buttons.forEach(btn => {
            const btnMode = btn.getAttribute('data-mode');
            if (btnMode === output.mode) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        });
      } catch (error) {
        console.error('Failed to refresh outputs:', error);
      }
    }

    // Use the poll interval from global data
    const refreshInterval = (globalData.PollInterval || 4) * 1000;
    setInterval(refreshAllOutputs, refreshInterval);
  </script>
</body>
</html>