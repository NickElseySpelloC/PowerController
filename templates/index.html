<!doctype html>
<!-- Generated by Claude Sonnet 4 -->
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ global_data.AppLabel }}</title>
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
  <div id="page" data-app-label="{{ global_data.AppLabel }}"></div>

  {% if global_data.TempProbeData and global_data.TempProbeData|length > 0 %}
  <div class="card" id="temp-probes">
    <div class="main-row">
      <div class="output-info">
        <div style="font-weight:600">Temperature Probes</div>
      </div>
    </div>
    <div class="row">
      <table>
        <tr>
          <th class="info_td_label">Probe</th>
          <th class="info_td_label">Temperature</th>
          <th class="info_td_label">As at</th>
        </tr>
        {% for probe in global_data.TempProbeData %}
        <tr data-probe-name="{{ probe.name }}">
          <td class="info_td_value">{{ probe.name }}</td>
          <td class="info_td_value"><span data-probe-field="temperature">{{ probe.temperature }}</span> Â°C</td>
          <td class="info_td_value"><span data-probe-field="last_logged_time">{{ probe.last_logged_time }}</span></td>
        </tr>
        {% endfor %}
      </table>

    </div>
  </div>
  {% endif %}  

  <div id="output-list">
    {% for output_id, output in outputs.items() %}
        <div class="card" data-output-id="{{ output.id }}"
          data-max-app-mode-on-minutes="{{ output.max_app_mode_on_minutes|default('', true) }}"
          data-max-app-mode-off-minutes="{{ output.max_app_mode_off_minutes|default('', true) }}">
      <div class="main-row">
        <div class="output-info">
          <div style="font-weight:600">{{ output.name }}</div>
          <div class="status-line">
            <span>Mode: <span class="mode-display" data-field="mode">{{ output.mode.upper() }}</span></span>
            <div class="reason-wrapper">
              <span class="pill status-pill {{ 'on' if output.is_on else 'off' }}">
                {{ 'ON' if output.is_on else 'OFF' }}
              </span>
              <span class="reason-text" data-field="reason">
                {{ output.reason if output.reason else '' }}
              </span>
            </div>
          </div>
        </div>
        {% if output.allow_actions %}
        <div class="button-group">
          <button class="mode-btn {{ 'active' if output.mode == 'on' else '' }}" 
                  data-mode="on" 
                  onclick="setMode('{{ output.id }}', 'on')">On</button>
          <button class="mode-btn {{ 'active' if output.mode == 'off' else '' }}" 
                  data-mode="off" 
                  onclick="setMode('{{ output.id }}', 'off')">Off</button>
          <button class="mode-btn {{ 'active' if output.mode == 'auto' else '' }}" 
                  data-mode="auto" 
                  onclick="setMode('{{ output.id }}', 'auto')">Auto</button>
        </div>
        {% endif %}
      </div>
      <div class="row">
        <!-- Full table for desktop -->
        <table class="info_table full">
          <!-- Column 1: Hours. Col 2: Energy, Col 3: Costs -->
          <tr>
            <td class="info_td_label" data-field="start_stop_label">{{ 'Stop At:' if output.is_on else 'Start At:' }}</td>
            <td class="info_td_value" data-field="start_stop_time">{{ output.stopping_at if output.is_on else output.next_start_time }}</td>

            <td class="info_td_label">Energy Used:</td>
            <td class="info_td_value" data-field="actual_energy_used">{{ output.actual_energy_used }}</td>

            <td class="info_td_label">Current Price:</td>
            <td class="info_td_value" data-field="current_price">{{ output.current_price }}</td>

            <td class="info_td_label">Actual Cost:</td>
            <td class="info_td_value" data-field="actual_cost">{{ output.actual_cost }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Target Hours:</td>
            <td class="info_td_value" data-field="target_hours">{{ output.target_hours }}</td>

            <td class="info_td_label">Planned Energy:</td>
            <td class="info_td_value" data-field="forecast_energy_used">{{ output.forecast_energy_used }}</td>

            <td class="info_td_label">Forecast Price:</td>
            <td class="info_td_value" data-field="forecast_price">{{ output.forecast_price }}</td>

            <td class="info_td_label">Forecast Cost:</td>
            <td class="info_td_value" data-field="forecast_cost">{{ output.forecast_cost }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Actual Hours:</td>
            <td class="info_td_value" data-field="actual_hours">{{ output.actual_hours }}</td>

            <td class="info_td_label">Total Energy:</td>
            <td class="info_td_value" data-field="total_energy_used">{{ output.total_energy_used }}</td>

            <td class="info_td_label">Average Price:</td>
            <td class="info_td_value" data-field="average_price">{{ output.average_price }}</td>

            <td class="info_td_label">Total Cost:</td>
            <td class="info_td_value" data-field="total_cost">{{ output.total_cost }}</td>
          </tr>
          <tr>
            <td class="info_td_label">Required Hours:</td>
            <td class="info_td_value" data-field="required_hours">{{ output.required_hours }}</td>

            <td class="info_td_label">Power Draw:</td>
            <td class="info_td_value" data-field="power_draw">{{ output.power_draw }}</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>
          </tr>
          <tr>
            <td class="info_td_label">Planned Hours:</td>
            <td class="info_td_value" data-field="planned_hours">{{ output.planned_hours }}</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>
          </tr>
        </table>

        <!-- Compact table for mobile -->
        <table class="info_table compact">
          <tr>
            <td class="info_td_label" data-field="start_stop_label">{{ 'Stop At:' if output.is_on else 'Start At:' }}</td>
            <td class="info_td_value" data-field="start_stop_time">{{ output.stopping_at if output.is_on else output.next_start_time }}</td>

            <td class="info_td_label">Current Price:</td>
            <td class="info_td_value" data-field="current_price">{{ output.current_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Target Hours:</td>
            <td class="info_td_value" data-field="target_hours">{{ output.target_hours }}</td>

            <td class="info_td_label">Forecast Price:</td>
            <td class="info_td_value" data-field="forecast_price">{{ output.forecast_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Actual Hours:</td>
            <td class="info_td_value" data-field="actual_hours">{{ output.actual_hours }}</td>

            <td class="info_td_label">Average Price:</td>
            <td class="info_td_value" data-field="average_price">{{ output.average_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Planned Hours:</td>
            <td class="info_td_value" data-field="planned_hours">{{ output.planned_hours }}</td>

            <td class="info_td_label">Power Draw:</td>
            <td class="info_td_value" data-field="power_draw">{{ output.power_draw }}</td>
          </tr>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>

  <script>
    // Use URL query param ?key=... for auth (no key is needed if Website.AccessKey is blank)
    const accessKey = new URLSearchParams(window.location.search).get('key');

    let ws = null;
    const latestOutputsById = new Map();

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = new URL(`${protocol}//${window.location.host}/ws`);
      if (accessKey) {
        wsUrl.searchParams.set('key', accessKey);
      }

      ws = new WebSocket(wsUrl.toString());

      ws.onopen = () => {
        console.log('WebSocket connected');
      };

      ws.onmessage = (event) => {
        let msg;
        try {
          msg = JSON.parse(event.data);
        } catch (e) {
          console.error('Bad JSON from server:', event.data);
          return;
        }

        if (msg.type === 'state_update' && msg.state) {
          applySnapshot(msg.state);
        }
      };

      ws.onclose = () => {
        console.log('WebSocket closed; reconnecting soon');
        ws = null;
        setTimeout(connectWebSocket, 2000);
      };
    }

    function setMode(outputId, mode) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.warn('WebSocket not connected; cannot send command');
        return;
      }

      function parseOptionalInt(v) {
        if (typeof v !== 'string') return null;
        const s = v.trim();
        if (!s) return null;
        const n = Number(s);
        if (!Number.isFinite(n) || !Number.isInteger(n)) return null;
        return n;
      }

      let revertTimeMins = null;
      if (mode === 'on' || mode === 'off') {
        const output = latestOutputsById.get(outputId);

        let defaultMins = null;
        if (output) {
          if (mode === 'on') {
            defaultMins = output.max_app_mode_on_minutes;
          } else {
            defaultMins = (output.max_app_mode_off_minutes ?? output.max_app_mode_on_minutes);
          }
        } else {
          const card = document.querySelector(`[data-output-id="${outputId}"]`);
          if (card && card.dataset) {
            if (mode === 'on') {
              defaultMins = parseOptionalInt(card.dataset.maxAppModeOnMinutes);
            } else {
              defaultMins = (parseOptionalInt(card.dataset.maxAppModeOffMinutes) ?? parseOptionalInt(card.dataset.maxAppModeOnMinutes));
            }
          }
        }

        const defaultText = (typeof defaultMins === 'number' && Number.isFinite(defaultMins)) ? String(defaultMins) : '';
        const promptText = `Minutes before reverting to AUTO (blank = no revert):`;
        const input = window.prompt(promptText, defaultText);
        if (input === null) {
          return; // user cancelled
        }
        const trimmed = input.trim();
        if (trimmed !== '') {
          const n = Number(trimmed);
          if (!Number.isFinite(n) || !Number.isInteger(n) || n < 0) {
            window.alert('Please enter a whole number of minutes (0 or more), or leave blank.');
            return;
          }
          revertTimeMins = n;
        }
      }

      ws.send(JSON.stringify({
        type: 'command',
        action: 'set_mode',
        output_id: outputId,
        mode: mode,
        revert_time_mins: revertTimeMins
      }));
    }

    function applySnapshot(snapshot) {
      // Temp probes
      if (snapshot.global && Array.isArray(snapshot.global.TempProbeData)) {
        snapshot.global.TempProbeData.forEach((probe) => {
          const row = document.querySelector(`#temp-probes tr[data-probe-name="${CSS.escape(probe.name)}"]`);
          if (!row) return;
          const tempEl = row.querySelector('[data-probe-field="temperature"]');
          const timeEl = row.querySelector('[data-probe-field="last_logged_time"]');
          if (tempEl) tempEl.textContent = probe.temperature ?? '';
          if (timeEl) timeEl.textContent = probe.last_logged_time ?? '';
        });
      }

      // Outputs
      const outputs = snapshot.outputs || {};
      Object.values(outputs).forEach((output) => {
        if (!output || !output.id) return;

        latestOutputsById.set(output.id, output);
        const card = document.querySelector(`[data-output-id="${output.id}"]`);
        if (!card) return;

        // Mode display
        const modeEl = card.querySelector('[data-field="mode"]');
        if (modeEl && output.mode) modeEl.textContent = String(output.mode).toUpperCase();

        // Status pill
        if (typeof output.is_on === 'boolean') {
          const pill = card.querySelector('.status-pill');
          if (pill) {
            pill.className = `pill status-pill ${output.is_on ? 'on' : 'off'}`;
            pill.textContent = output.is_on ? 'ON' : 'OFF';
          }
        }

        // Reason
        const reasonEl = card.querySelector('[data-field="reason"]');
        if (reasonEl) reasonEl.textContent = output.reason || '';

        // Start/stop label + time
        const startStopLabel = card.querySelectorAll('[data-field="start_stop_label"]');
        const startStopTime = card.querySelectorAll('[data-field="start_stop_time"]');
        const isOn = !!output.is_on;
        startStopLabel.forEach((el) => el.textContent = isOn ? 'Stop At:' : 'Start At:');
        const timeValue = isOn ? (output.stopping_at || '') : (output.next_start_time || '');
        startStopTime.forEach((el) => el.textContent = timeValue);

        // Simple field updates
        const fields = [
          'actual_energy_used', 'actual_cost', 'current_price',
          'target_hours', 'forecast_energy_used', 'forecast_price', 'forecast_cost',
          'actual_hours', 'total_energy_used', 'average_price', 'total_cost',
          'required_hours', 'power_draw', 'planned_hours'
        ];
        fields.forEach((field) => {
          const elements = card.querySelectorAll(`[data-field="${field}"]`);
          elements.forEach((el) => {
            const v = output[field];
            el.textContent = (v === null || v === undefined) ? '' : String(v);
          });
        });

        // Button active states
        if (output.mode) {
          const buttons = card.querySelectorAll('.mode-btn');
          buttons.forEach((btn) => {
            const btnMode = btn.getAttribute('data-mode');
            if (btnMode === output.mode) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        }
      });
    }

    // Full page refresh to pick up template/config changes
    setInterval(() => window.location.reload(), 60000);

    connectWebSocket();
</script>
</body>
</html>