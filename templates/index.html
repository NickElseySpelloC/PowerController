<!doctype html>
<!-- Generated by Claude Sonnet 4 -->
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ global_data.AppLabel }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
  <script id="global-data-json" type="application/json">
    {{ global_data | tojson | safe }}
  </script>

  {% if temp_probes and temp_probes|length > 0 %}
  <div class="card" id="temp-probes">
    <div class="main-row">
      <div class="output-info">
        <div style="font-weight:600">Temperature Probes</div>
      </div>
    </div>
    <div class="row">
      <table class="info_table full">
        <tr>
          <th class="info_td_label">Probe</th>
          <th class="info_td_label">Temperature</th>
          <th class="info_td_label">As at</th>
        </tr>
        {% for probe in global_data.TempProbeData %}
        <tr>
          <td class="info_td_value">{{ probe.name }}</td>
          <td class="info_td_value">{{ probe.temperature }} Â°C</td>
          <td class="info_td_value">{{ probe.last_logged_time }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
  {% endif %}  

  <div id="output-list">
    {% for output_id, output in outputs.items() %}
    <div class="card" data-output-id="{{ output.id }}">
      <div class="main-row">
        <div class="output-info">
          <div style="font-weight:600">{{ output.name }}</div>
          <div class="status-line">
            <span>Mode: <span class="mode-display">{{ output.mode.upper() }}</span></span>
            <div class="reason-wrapper">
              <span class="pill status-pill {{ 'on' if output.is_on else 'off' }}">
                {{ 'ON' if output.is_on else 'OFF' }}
              </span>
              <span class="reason-text">
                {{ output.reason if output.reason else '' }}
              </span>
            </div>
          </div>
        </div>
        <div class="button-group">
          <button class="mode-btn {{ 'active' if output.mode == 'on' else '' }}" 
                  data-mode="on" 
                  onclick="setMode('{{ output.id }}', 'on')">On</button>
          <button class="mode-btn {{ 'active' if output.mode == 'off' else '' }}" 
                  data-mode="off" 
                  onclick="setMode('{{ output.id }}', 'off')">Off</button>
          <button class="mode-btn {{ 'active' if output.mode == 'auto' else '' }}" 
                  data-mode="auto" 
                  onclick="setMode('{{ output.id }}', 'auto')">Auto</button>
        </div>
      </div>
      <div class="row">
        <!-- Full table for desktop -->
        <table class="info_table full">
          <!-- Column 1: Hours. Col 2: Energy, Col 3: Costs -->
          <tr>
            <td class="info_td_label">{{ 'Stop At:' if output.is_on else 'Start At:' }}</td>
            <td class="info_td_value">{{ output.stopping_at if output.is_on else output.next_start_time }}</td>

            <td class="info_td_label">Energy Used:</td>
            <td class="info_td_value">{{ output.actual_energy_used }}</td>

            <td class="info_td_label">Current Price:</td>
            <td class="info_td_value">{{ output.current_price }}</td>

            <td class="info_td_label">Actual Cost:</td>
            <td class="info_td_value">{{ output.actual_cost }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Target Hours:</td>
            <td class="info_td_value">{{ output.target_hours }}</td>

            <td class="info_td_label">Planned Energy:</td>
            <td class="info_td_value">{{ output.forecast_energy_used }}</td>

            <td class="info_td_label">Forecast Price:</td>
            <td class="info_td_value">{{ output.forecast_price }}</td>

            <td class="info_td_label">Forecast Cost:</td>
            <td class="info_td_value">{{ output.forecast_cost }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Actual Hours:</td>
            <td class="info_td_value">{{ output.actual_hours }}</td>

            <td class="info_td_label">Total Energy:</td>
            <td class="info_td_value">{{ output.total_energy_used }}</td>

            <td class="info_td_label">Average Price:</td>
            <td class="info_td_value">{{ output.average_price }}</td>

            <td class="info_td_label">Total Cost:</td>
            <td class="info_td_value">{{ output.total_cost }}</td>
          </tr>
          <tr>
            <td class="info_td_label">Required Hours:</td>
            <td class="info_td_value">{{ output.required_hours }}</td>

            <td class="info_td_label">Power Draw:</td>
            <td class="info_td_value">{{ output.power_draw }}</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>
          </tr>
          <tr>
            <td class="info_td_label">Planned Hours:</td>
            <td class="info_td_value">{{ output.planned_hours }}</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>

            <td class="info_td_label">&nbsp;</td>
            <td class="info_td_value">&nbsp;</td>
          </tr>
        </table>

        <!-- Compact table for mobile -->
        <table class="info_table compact">
          <tr>
            <td class="info_td_label">{{ 'Stop At:' if output.is_on else 'Start At:' }}</td>
            <td class="info_td_value">{{ output.stopping_at if output.is_on else output.next_start_time }}</td>

            <td class="info_td_label">Current Price:</td>
            <td class="info_td_value">{{ output.current_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Target Hours:</td>
            <td class="info_td_value">{{ output.target_hours }}</td>

            <td class="info_td_label">Forecast Price:</td>
            <td class="info_td_value">{{ output.forecast_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Actual Hours:</td>
            <td class="info_td_value">{{ output.actual_hours }}</td>

            <td class="info_td_label">Average Price:</td>
            <td class="info_td_value">{{ output.average_price }}</td>
          </tr>

          <tr>
            <td class="info_td_label">Planned Hours:</td>
            <td class="info_td_value">{{ output.planned_hours }}</td>

            <td class="info_td_label">Power Draw:</td>
            <td class="info_td_value">{{ output.power_draw }}</td>
          </tr>
        </table>
      </div>
    </div>
    {% endfor %}
  </div>

  <script>
    // Store global data from server
    const globalData = JSON.parse(document.getElementById('global-data-json').textContent);

    // Helper function to build URL with access key if needed
    function buildApiUrl(path) {
      if (globalData.access_key) {
        const separator = path.includes('?') ? '&' : '?';
        return `${path}${separator}key=${encodeURIComponent(globalData.access_key)}`;
      }
      return path;
    }

    async function fetchOutputs() {
      const res = await fetch(buildApiUrl('/api/outputs'));
      return await res.json();
    }

    // NEW: Fetch a single output snapshot by ID
    async function fetchOutput(id) {
      const res = await fetch(buildApiUrl(`/api/outputs/${id}`));
      if (res.ok) {
        return await res.json();
      }
      throw new Error(`Failed to fetch output ${id}`);
    }

    async function setMode(id, mode) {
      try {
        console.log(`Setting mode ${mode} for output ${id}`);
        
        const response = await fetch(buildApiUrl(`/api/outputs/${id}/mode`), {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode })
        });

        if (response.ok) {
          const output = await response.json();
          updateOutputDisplay(output.id || id, output);                    
        } else {
          console.error('Failed to set mode 1:', response.statusText);
        }
      } catch (error) {
        console.error('Failed to set mode 2:', error);
      }
    }

    function updateOutputDisplay(outputId, outputData) {
      // Find the card for this output
      const card = document.querySelector(`[data-output-id="${outputId}"]`);

      console.error(`Updating display for output ${outputId}:`, outputData);
      if (!card) return;

      // Update mode display if provided
      if (outputData.mode) {
        const modeDisplay = card.querySelector('.mode-display');
        if (modeDisplay) {
          modeDisplay.textContent = outputData.mode.toUpperCase();
        }
      }

      // Update status pill if is_on is provided
      if (outputData.is_on !== undefined) {
        const statusPill = card.querySelector('.status-pill');
        if (statusPill) {
          statusPill.className = `pill status-pill ${outputData.is_on ? 'on' : 'off'}`;
          statusPill.textContent = outputData.is_on ? 'ON' : 'OFF';
        }
      }

      // Update reason text if provided
      if (outputData.reason !== undefined) {
        const reasonSpan = card.querySelector('.reason-text');
        if (reasonSpan) {
          reasonSpan.textContent = outputData.reason || '';
        }
      }

      // Update button states if mode is provided
      if (outputData.mode) {
        const buttons = card.querySelectorAll('.mode-btn');
        buttons.forEach(btn => {
          const btnMode = btn.getAttribute('data-mode');
          if (btnMode === outputData.mode) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }
    }

    async function refreshAllOutputs() {
      try {
        const data = await fetchOutputs();

        // Update each output's display using updateOutputDisplay
        Object.values(data.outputs).forEach(output => {
          updateOutputDisplay(output.id, output);
        });
      } catch (error) {
        console.error('Failed to refresh outputs:', error);
      }
    }

    // Use the poll interval from global data
    const refreshInterval = (globalData.PollInterval || 4) * 1000;
    setInterval(refreshAllOutputs, refreshInterval);
</script>
</body>
</html>